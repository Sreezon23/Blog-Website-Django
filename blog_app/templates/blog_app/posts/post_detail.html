{% extends "blog_app/base.html" %}
{% load static %}

{% block title %}
    {{ post.title }} - Barça Buzz
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8 animate-fade-in">
    
    <!-- Back Link -->
    <div class="mb-6">
        <a href="{% url 'post_list' %}" class="inline-flex items-center text-gray-600 hover:text-barca-blue transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Posts
        </a>
    </div>

    <!-- Post Container -->
    <article class="bg-white rounded-2xl shadow-xl overflow-hidden">
        <!-- Header Image -->
        {% if post.featured_image %}
            <div class="h-64 bg-gradient-to-r from-barca-blue to-barca-red relative">
                <img src="{{ post.featured_image.url }}" alt="{{ post.title }}" 
                     class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center">
                    <h1 class="text-white text-3xl font-bold text-center px-4">{{ post.title }}</h1>
                </div>
            </div>
        {% endif %}

        <!-- Content -->
        <div class="p-8">
            <!-- Title (if no featured image) -->
            {% if not post.featured_image %}
                <h1 class="text-3xl font-bold mb-6 text-gray-800">{{ post.title }}</h1>
            {% endif %}

            <!-- Meta Info -->
            <div class="flex flex-wrap items-center gap-4 mb-6 text-sm text-gray-600">
                <div class="flex items-center">
                    <i class="fas fa-calendar mr-2"></i>
                    <time datetime="{{ post.published_date|date:'c' }}">{{ post.published_date|date:"F j, Y" }}</time>
                </div>
                {% if post.category %}
                    <div class="flex items-center">
                        <i class="fas fa-folder mr-2"></i>
                        <a href="{{ post.category.get_absolute_url }}" 
                           class="hover:text-barca-blue transition-colors">
                            {{ post.category.name }}
                        </a>
                    </div>
                {% endif %}
                <div class="flex items-center">
                    <i class="fas fa-user mr-2"></i>
                    <span>By {{ post.author.username }}</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-eye mr-2"></i>
                    <span>{{ post.views_count }} views</span>
                </div>
            </div>

            <!-- Tags -->
            {% if post.tags.all %}
                <div class="flex flex-wrap gap-2 mb-6">
                    {% for tag in post.tags.all %}
                        <a href="{{ tag.get_absolute_url }}" 
                           class="inline-block px-3 py-1 bg-barca-gold text-white text-sm rounded-full hover:bg-yellow-600 transition-colors">
                            #{{ tag.name }}
                        </a>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Excerpt -->
            {% if post.excerpt %}
                <div class="text-gray-600 mb-6 text-lg leading-relaxed">
                    {{ post.excerpt }}
                </div>
            {% endif %}

            <!-- Content -->
            <div class="prose prose-lg max-w-none text-gray-800">
                {{ post.text|safe }}
            </div>
        </div>
    </article>

    <!-- Actions -->
    <div class="mt-8 flex flex-wrap gap-4">
        {% if user == post.author or user.is_superuser %}
            <a href="{% url 'post_edit' slug=post.slug %}" 
               class="inline-flex items-center px-4 py-2 bg-barca-blue text-white rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-edit mr-2"></i>
                Edit Post
            </a>
        {% endif %}

        {% if user == post.author or user.is_superuser %}
            <a href="{% url 'post_remove' slug=post.slug %}" 
               class="inline-flex items-center px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
               onclick="return confirm('Are you sure you want to delete this post?')">
                <i class="fas fa-trash mr-2"></i>
                Delete Post
            </a>
        {% endif %}

        {% if user.is_authenticated %}
            <button onclick="toggleLike()" 
                    class="like-btn {% if is_liked %}liked{% endif %} inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                <i class="fas fa-heart mr-2"></i>
                <span class="like-count">{{ post.likes.count }}</span>
            </button>

            <button onclick="toggleBookmark()" 
                    class="bookmark-btn {% if is_bookmarked %}bookmarked{% endif %} inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                <i class="fas fa-bookmark mr-2"></i>
                {% if is_bookmarked %}Bookmarked{% else %}Bookmark{% endif %}
            </button>
        {% endif %}
    </div>

    <!-- Comments Section -->
    <div class="mt-12">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Comments</h2>
        
        {% if comments %}
            <div class="space-y-6">
                {% for comment in comments %}
                    <div class="bg-gray-50 rounded-lg p-6">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <strong class="text-gray-800">{{ comment.author }}</strong>
                                <span class="text-gray-500 text-sm ml-2">
                                    {{ comment.created_date|date:"F j, Y, g:i A" }}
                                </span>
                            </div>
                            {% if comment.approved_comments %}
                                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full">
                                    ✓ Approved
                                </span>
                            {% else %}
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-semibold rounded-full">
                                    ⏳ Pending
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    <p class="text-gray-700">{{ comment.text }}</p>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-12 bg-gray-50 rounded-lg">
                <i class="fas fa-comments text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600">No comments yet. Be the first to share your thoughts!</p>
            </div>
        {% endif %}

        <!-- Comment Form -->
        {% if user.is_authenticated %}
            <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">Leave a Comment</h3>
                <form method="post" action="{% url 'add_comment_to_post' slug=post.slug %}" class="space-y-4">
                    {% csrf_token %}
                    
                    <div class="space-y-2">
                        <label for="{{ comment_form.author.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Your Name
                        </label>
                        {{ comment_form.author }}
                    </div>

                    <div class="space-y-2">
                        <label for="{{ comment_form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Email (optional)
                        </label>
                        {{ comment_form.email }}
                    </div>

                    <div class="space-y-2">
                        <label for="{{ comment_form.text.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Comment
                        </label>
                        {{ comment_form.text }}
                    </div>

                    <button type="submit" 
                            class="w-full px-4 py-3 bg-gradient-to-r from-barca-blue to-barca-red text-white font-semibold rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Post Comment
                    </button>
                </form>
            </div>
        {% else %}
            <div class="text-center py-12 bg-gray-50 rounded-lg">
                <i class="fas fa-comment text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600 mb-4">Please <a href="{% url 'login' %}" class="text-barca-blue hover:underline">log in</a> to leave a comment.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- JavaScript for Like/Bookmark functionality -->
{% if user.is_authenticated %}
<script>
    function toggleLike() {
        fetch("{% url 'toggle_like' slug=post.slug %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            const btn = document.querySelector('.like-btn');
            const count = document.querySelector('.like-count');
            
            if (data.liked) {
                btn.classList.add('liked');
                count.textContent = parseInt(count.textContent) + 1;
            } else {
                btn.classList.remove('liked');
                count.textContent = parseInt(count.textContent) - 1;
            }
        });
    }

    function toggleBookmark() {
        fetch("{% url 'toggle_bookmark' slug=post.slug %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            const btn = document.querySelector('.bookmark-btn');
            
            if (data.bookmarked) {
                btn.classList.add('bookmarked');
                btn.innerHTML = '<i class="fas fa-bookmark mr-2"></i>Bookmarked';
            } else {
                btn.classList.remove('bookmarked');
                btn.innerHTML = '<i class="fas fa-bookmark mr-2"></i>Bookmark';
            }
        });
    }

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }
</script>
{% endif %}

<style>
    .like-btn.liked {
        background-color: #ef4444;
        color: white;
    }
    .bookmark-btn.bookmarked {
        background-color: #f59e0b;
        color: white;
    }
    .prose {
        max-width: none;
    }
</style>
{% endblock %}
