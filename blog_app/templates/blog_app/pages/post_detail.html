{% extends "blog_app/base.html" %}
{% load static %}

{% block title %}{{ post.title }} - Bar√ßa Buzz{% endblock %}

{% block content %}

<!-- POST HEADER -->
<div class="post-detail-header">
    <div class="post-category-section">
        {% if post.category %}
            <a href="{{ post.category.get_absolute_url }}" class="category-badge">
                {% if post.category.icon %}<i class="bi {{ post.category.icon }}"></i>{% endif %}
                {{ post.category.name }}
            </a>
        {% endif %}
    </div>
    
    <h1 class="post-detail-title">{{ post.title }}</h1>
    
    <div class="post-meta-info">
        <div class="meta-item">
            <i class="bi bi-person-circle"></i>
            <div>
                <strong>{{ post.author.first_name|default:post.author.username }}</strong>
                {% if post.author.email %}
                    <br><small>{{ post.author.email }}</small>
                {% endif %}
            </div>
        </div>
        
        <div class="meta-item">
            <i class="bi bi-calendar-event"></i>
            {{ post.published_date|date:"F d, Y" }}
        </div>
        
        <div class="meta-item">
            <i class="bi bi-clock"></i>
            {{ post.published_date|time:"g:i A" }}
        </div>
        
        <div class="meta-item meta-views">
            <i class="bi bi-eye"></i>
            {{ post.views_count }} views
        </div>
    </div>
</div>

<!-- BREADCRUMB -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
        {% if post.category %}
            <li class="breadcrumb-item"><a href="{{ post.category.get_absolute_url }}">{{ post.category.name }}</a></li>
        {% endif %}
        <li class="breadcrumb-item active" aria-current="page">{{ post.title|truncatewords:8 }}</li>
    </ol>
</nav>

<!-- AUTHOR BIO -->
<div class="author-bio-card">
    {% if post.author.author_profile and post.author.author_profile.avatar %}
        <img src="{{ post.author.author_profile.avatar.url }}" alt="{{ post.author.username }}" class="author-avatar">
    {% else %}
        <div class="author-avatar-placeholder">
            <i class="bi bi-person"></i>
        </div>
    {% endif %}
    <div>
        <div class="fw-bold">{{ post.author.first_name|default:post.author.username }}</div>
        {% if post.author.author_profile and post.author.author_profile.bio %}
            <small class="text-muted d-block">{{ post.author.author_profile.bio|truncatewords:20 }}</small>
        {% endif %}
    </div>
</div>

<!-- FEATURED IMAGE -->
{% if post.featured_image %}
    <div class="post-featured-image">
        <img loading="lazy" src="{{ post.featured_image.url }}" alt="{{ post.title }}">
    </div>
{% endif %}

<!-- MAIN CONTENT -->
<div class="row">
    <div class="col-lg-8">
        <article class="post-content">
            {{ post.text|safe }}
        </article>
        
        <!-- LIKE & SAVE BUTTONS -->
        <div class="post-actions-buttons">
            <button class="btn btn-outline-primary btn-sm" id="likeBtn">
                <i class="bi bi-heart"></i> Like ({{ post.likes.count }})
            </button>
            <button class="btn btn-outline-secondary btn-sm" id="bmBtn">
                <i class="bi bi-bookmark"></i> Save
            </button>
        </div>

        <script>
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');
            document.getElementById('likeBtn')?.addEventListener('click', async () => {
                const r = await fetch("{% url 'toggle_like' post.slug %}", {method:'POST', headers:{'X-CSRFToken': csrftoken}});
                if(r.ok) location.reload();
            });
            document.getElementById('bmBtn')?.addEventListener('click', async () => {
                const r = await fetch("{% url 'toggle_bookmark' post.slug %}", {method:'POST', headers:{'X-CSRFToken': csrftoken}});
                if(r.ok) alert('Saved to your bookmarks');
            });
        </script>

        <!-- TAGS -->
        {% if post.tags.all %}
            <div class="post-tags-section">
                <strong><i class="bi bi-tag"></i> Tags:</strong>
                <div class="tags-container">
                    {% for tag in post.tags.all %}
                        <a href="{{ tag.get_absolute_url }}" class="tag-link">{{ tag.name }}</a>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- POST MANAGEMENT (Author/Admin) -->
        {% if user.is_authenticated and user == post.author or user.is_superuser %}
            <div class="post-management-section">
                <strong><i class="bi bi-pencil-square"></i> Post Management</strong>
                <div class="management-actions">
                    {% if post.status == 'draft' %}
                        <a href="{% url 'post_publish' post.slug %}" class="btn btn-sm btn-success">
                            <i class="bi bi-check-circle"></i> Publish Post
                        </a>
                    {% endif %}
                    
                    <a href="{% url 'post_edit' post.slug %}" class="btn btn-sm btn-primary">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                    
                    {% if post.status == 'published' %}
                        <a href="{% url 'post_archive' post.slug %}" class="btn btn-sm btn-warning">
                            <i class="bi bi-archive"></i> Archive
                        </a>
                    {% endif %}
                    
                    <a href="{% url 'post_remove' post.slug %}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this post?');">
                        <i class="bi bi-trash"></i> Delete
                    </a>
                </div>
            </div>
        {% endif %}

        <!-- COMMENTS SECTION -->
        <div class="comments-section">
            <h3 class="comments-title"><i class="bi bi-chat-dots"></i> Discussion</h3>
            
            {% if user.is_authenticated %}
                <div class="comment-form-wrapper">
                    <h4>Leave a Comment</h4>
                    <form method="post" action="{% url 'add_comment_to_post' post.slug %}">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="id_text">Your Comment</label>
                            <textarea name="text" id="id_text" rows="5" class="form-control" placeholder="Share your thoughts..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send"></i> Post Comment
                        </button>
                    </form>
                </div>
            {% else %}
                <div class="login-prompt-box">
                    <p>
                        <i class="bi bi-info-circle"></i> 
                        <a href="{% url 'login' %}">Log in</a> to leave a comment
                    </p>
                </div>
            {% endif %}

            <!-- COMMENTS LIST -->
            {% if comments %}
                <div class="comments-list">
                    <h4>{{ comments.count }} Comment{{ comments.count|pluralize }}</h4>
                    
                    {% for comment in comments %}
                        <div class="comment-item">
                            <div class="comment-header">
                                <div>
                                    <strong>{{ comment.author }}</strong>
                                    {% if comment.email %}
                                        <small>{{ comment.email }}</small>
                                    {% endif %}
                                </div>
                                <small class="comment-date">{{ comment.created_date|date:"M d, Y - g:i A" }}</small>
                            </div>
                            
                            <p class="comment-text">{{ comment.text }}</p>
                            
                            <!-- MODERATION (Admin Only) -->
                            {% if user.is_superuser or user.is_staff %}
                                <div class="comment-moderation">
                                    <a href="{% url 'remove_comment' comment.pk %}" class="btn btn-sm btn-danger">
                                        <i class="bi bi-trash"></i> Remove
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-comments-placeholder">
                    <i class="bi bi-chat-left"></i>
                    <p>No comments yet. Be the first to share your thoughts!</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- SIDEBAR -->
    <div class="col-lg-4">
        <!-- RELATED POSTS -->
        {% if related_posts %}
            <div class="related-posts-widget">
                <h4><i class="bi bi-link-45deg"></i> Related Posts</h4>
                
                {% for related_post in related_posts %}
                    <a href="{{ related_post.get_absolute_url }}" class="related-post-link">
                        <strong>{{ related_post.title }}</strong>
                        <small>{{ related_post.published_date|date:"M d, Y" }}</small>
                    </a>
                {% endfor %}
            </div>
        {% endif %}

        <!-- SHARE SECTION -->
        <div class="share-widget">
            <h4><i class="bi bi-share"></i> Share</h4>
            
            <div class="share-buttons">
                <a href="https://twitter.com/intent/tweet?text={{ post.title }}&url={% url 'post_detail' post.slug %}" target="_blank" class="share-btn share-twitter">
                    <i class="bi bi-twitter"></i> Tweet
                </a>
                
                <a href="https://www.facebook.com/sharer/sharer.php?u={% url 'post_detail' post.slug %}" target="_blank" class="share-btn share-facebook">
                    <i class="bi bi-facebook"></i> Share
                </a>
                
                <a href="https://www.linkedin.com/sharing/share-offsite/?url={% url 'post_detail' post.slug %}" target="_blank" class="share-btn share-linkedin">
                    <i class="bi bi-linkedin"></i> Post
                </a>
            </div>
        </div>
    </div>
</div>

{% endblock %}
